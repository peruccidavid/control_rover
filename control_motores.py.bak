# Bloque de simulación - Comentar o eliminar cuando se ejecute en el Pi
import sys
sys.path.append('.')

# Intentar usar RPi.GPIO; si falla en import o en cualquier operación de inicialización,
# hacer fallback a mock_rpi_gpio para poder ejecutar en el PC/simulador.
try:
    import RPi.GPIO as GPIO
except Exception:
    import mock_rpi_gpio as GPIO

import time

# Configuración de pines (usando el modo BCM)
# Asigna los pines GPIO según la configuración del manual de conexiones
# Ruedas Delanteras (Módulo 1)
ESC_1_PIN = 18  # Pin para la rueda 1 (ESC 1)
ESC_2_PIN = 23  # Pin para la rueda 2 (ESC 2)

# Ruedas Medias (Módulo 2)
ESC_3_PIN = 24  # Pin para la rueda 3 (ESC 3)
ESC_4_PIN = 25  # Pin para la rueda 4 (ESC 4)

# Ruedas Traseras (Módulo 3)
ESC_5_PIN = 19  # Pin para la rueda 5 (ESC 5)
ESC_6_PIN = 26  # Pin para la rueda 6 (ESC 6)

# Pines para el control de los MOSFETs
MOSFET_1_PIN = 17
MOSFET_2_PIN = 27
MOSFET_3_PIN = 22

# --- Inicialización robusta de GPIO con fallback a mock ---
def _use_mock():
    import mock_rpi_gpio as GPIO_mock
    GPIO_mock.setmode(GPIO_mock.BCM)
    return GPIO_mock

# Intentar setmode + setup; si cualquier RuntimeError ocurre, volver al mock.
try:
    GPIO.setmode(GPIO.BCM)
    GPIO.setwarnings(False)
    for pin in [ESC_1_PIN, ESC_2_PIN, ESC_3_PIN, ESC_4_PIN, ESC_5_PIN, ESC_6_PIN]:
        GPIO.setup(pin, GPIO.OUT)
    for pin in [MOSFET_1_PIN, MOSFET_2_PIN, MOSFET_3_PIN]:
        GPIO.setup(pin, GPIO.OUT)
except RuntimeError:
    # Ejemplo de error: "Cannot determine SOC peripheral base address"
    GPIO = _use_mock()
    for pin in [ESC_1_PIN, ESC_2_PIN, ESC_3_PIN, ESC_4_PIN, ESC_5_PIN, ESC_6_PIN]:
        GPIO.setup(pin, GPIO.OUT)
    for pin in [MOSFET_1_PIN, MOSFET_2_PIN, MOSFET_3_PIN]:
        GPIO.setup(pin, GPIO.OUT)

# Configurar PWM para los ESCs (probar y fallback si PWM no está disponible)
PWM_FREQ = 50 
try:
    pwm_esc_1 = GPIO.PWM(ESC_1_PIN, PWM_FREQ)
    pwm_esc_2 = GPIO.PWM(ESC_2_PIN, PWM_FREQ)
    pwm_esc_3 = GPIO.PWM(ESC_3_PIN, PWM_FREQ)
    pwm_esc_4 = GPIO.PWM(ESC_4_PIN, PWM_FREQ)
    pwm_esc_5 = GPIO.PWM(ESC_5_PIN, PWM_FREQ)
    pwm_esc_6 = GPIO.PWM(ESC_6_PIN, PWM_FREQ)
except Exception:
    # Si el mock no tiene PWM o algo falla, volver a importar mock y crear stubs si es necesario.
    GPIO = _use_mock()
    # Algunos mocks exigen que PWM exista; si no, crea una clase PWM mínima
    if not hasattr(GPIO, "PWM"):
        class _DummyPWM:
            def __init__(self, pin, freq): pass
            def start(self, duty): pass
            def ChangeDutyCycle(self, duty): pass
            def stop(self): pass
        GPIO.PWM = _DummyPWM
    pwm_esc_1 = GPIO.PWM(ESC_1_PIN, PWM_FREQ)
    pwm_esc_2 = GPIO.PWM(ESC_2_PIN, PWM_FREQ)
    pwm_esc_3 = GPIO.PWM(ESC_3_PIN, PWM_FREQ)
    pwm_esc_4 = GPIO.PWM(ESC_4_PIN, PWM_FREQ)
    pwm_esc_5 = GPIO.PWM(ESC_5_PIN, PWM_FREQ)
    pwm_esc_6 = GPIO.PWM(ESC_6_PIN, PWM_FREQ)

# Iniciar PWM en ciclo de trabajo 0 (motor detenido)
pwm_esc_1.start(0)
pwm_esc_2.start(0)
pwm_esc_3.start(0)
pwm_esc_4.start(0)
pwm_esc_5.start(0)
pwm_esc_6.start(0)

# Funciones de control
def set_mosfet_state(state):
    """Controla el estado de los 3 MOSFETs (ON/OFF)."""
    level = GPIO.HIGH if state == "ON" else GPIO.LOW
    for pin in [MOSFET_1_PIN, MOSFET_2_PIN, MOSFET_3_PIN]:
        GPIO.output(pin, level)
    print("MOSFETs activados." if state == "ON" else "MOSFETs desactivados.")

def set_all_wheels_speed(duty_cycle):
    """Ajusta la velocidad de todas las ruedas con el mismo ciclo de trabajo.
    duty_cycle esperado en -100..100; se mapea a 0..100 para ChangeDutyCycle."""
    # limitar entrada
    if duty_cycle < -100:
        duty_cycle = -100
    if duty_cycle > 100:
        duty_cycle = 100
    # mapear -100..100 -> 0..100 (ajustar según el comportamiento real del ESC)
    pwm_value = (duty_cycle + 100) / 2.0
    for pwm in [pwm_esc_1, pwm_esc_2, pwm_esc_3, pwm_esc_4, pwm_esc_5, pwm_esc_6]:
        pwm.ChangeDutyCycle(pwm_value)
    print(f"Velocidad de todas las ruedas ajustada a {duty_cycle}% (PWM {pwm_value}%)")

def stop_all_wheels():
    """Detiene todos los motores."""
    set_all_wheels_speed(0)
    print("Todos los motores detenidos.")

def cleanup_gpio():
    """Limpia la configuración de los pines GPIO."""
    pwm_esc_1.stop()
    pwm_esc_2.stop()
    pwm_esc_3.stop()
    pwm_esc_4.stop()
    pwm_esc_5.stop()
    pwm_esc_6.stop()
    GPIO.cleanup()
    print("Configuración GPIO limpia.")

# Bucle principal de prueba
try:
    print("Modo de prueba de control de ruedas (simulación).")
    print("Activando MOSFETs y moviendo el Rover hacia adelante...")
    set_mosfet_state("ON")
    time.sleep(1) # Espera a que los ESCs se armen
    
    # Mover hacia adelante a 50% de velocidad
    set_all_wheels_speed(50)
    time.sleep(5) # Mover por 5 segundos
    
    # Detener y luego mover hacia atrás
    stop_all_wheels()
    time.sleep(2)
    
    print("Moviendo el Rover hacia atrás...")
    set_all_wheels_speed(-50) # Asumiendo un rango de -100 a 100
    time.sleep(5)
    
    # Detener y apagar MOSFETs
    stop_all_wheels()
    set_mosfet_state("OFF")

except KeyboardInterrupt:
    print("Prueba detenida por el usuario.")

finally:
    cleanup_gpio()